<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecionador de Gênero Musical</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: #ffffff;
        }
        .container {
            background-color: #181818;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        h1, h2 {
            color: #1DB954; /* Spotify green */
            text-align: center;
        }
        button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1ed760;
        }
        #login-container {
            text-align: center;
        }
        #genre-selection, #artist-list {
            display: none;
            text-align: center;
        }
        .genre-button {
            display: inline-block;
            width: 45%;
            margin: 10px;
        }
        #artist-container {
            text-align: left;
            margin-top: 20px;
        }
        #artist-container a {
            display: block;
            color: #ffffff;
            text-decoration: none;
            padding: 12px 15px;
            margin: 8px 0;
            background-color: #282828;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #artist-container a:hover {
            background-color: #333;
        }
        .artist-count {
            float: right;
            color: #1DB954;
        }
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1DB954;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #back-button {
            display: none;
            background-color: #333;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Selecionador de Gênero Musical</h1>
        
        <div id="login-container">
            <p>Conecte-se ao Spotify para descobrir artistas baseados nos seus gêneros favoritos.</p>
            <button id="login-button">Conectar ao Spotify</button>
        </div>
        
        <div id="loading">
            <p>Analisando suas músicas salvas...</p>
            <div class="spinner"></div>
        </div>
        
        <div id="genre-selection">
            <h2>Escolha um gênero musical:</h2>
            <div id="genre-buttons"></div>
        </div>
        
        <div id="artist-list">
            <h2 id="selected-genre-title"></h2>
            <div id="artist-container"></div>
            <button id="back-button">Voltar ao sorteio</button>
        </div>
    </div>

    <script>
        // Configurações do Spotify
        const clientId = 'cdbe0b644b984a6e98839e352d87bb3d';
        const redirectUri = 'https://gandradeiasi.github.io/selecionador-genero-random/';
        const scopes = 'user-library-read';
        
        // Elementos do DOM
        const loginButton = document.getElementById('login-button');
        const loginContainer = document.getElementById('login-container');
        const loadingElement = document.getElementById('loading');
        const genreSelection = document.getElementById('genre-selection');
        const genreButtons = document.getElementById('genre-buttons');
        const artistList = document.getElementById('artist-list');
        const artistContainer = document.getElementById('artist-container');
        const selectedGenreTitle = document.getElementById('selected-genre-title');
        const backButton = document.getElementById('back-button');
        
        // Variáveis globais
        let accessToken = null;
        let genreScores = {};
        let artistsByGenre = {};
        let selectedGenres = [];
        
        // Funções de autenticação
        function login() {
            let url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(clientId);
            url += '&scope=' + encodeURIComponent(scopes);
            url += '&redirect_uri=' + encodeURIComponent(redirectUri);
            window.location = url;
        }
        
        function getHashParams() {
            let hashParams = {};
            let e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }
        
        // Funções da API do Spotify
        async function fetchSavedTracks() {
            let tracks = [];
            let offset = 0;
            let totalTracks = 1; // Inicialmente maior que zero para começar o loop
            
            while (tracks.length < totalTracks) {
                const response = await fetch(`https://api.spotify.com/v1/me/tracks?limit=50&offset=${offset}`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar músicas salvas');
                }
                
                const data = await response.json();
                totalTracks = data.total;
                tracks = tracks.concat(data.items);
                offset += 50;
                
                // Limite de 200 faixas para evitar muitas requisições
                if (tracks.length >= 200) break;
            }
            
            return tracks;
        }
        
        async function fetchArtistGenres(artistId) {
            const response = await fetch(`https://api.spotify.com/v1/artists/${artistId}`, {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });
            
            if (!response.ok) {
                throw new Error('Erro ao buscar gêneros do artista');
            }
            
            const data = await response.json();
            return data.genres;
        }
        
        // Funções de processamento
        async function processSavedTracks() {
            try {
                loadingElement.style.display = 'block';
                loginContainer.style.display = 'none';
                
                const tracks = await fetchSavedTracks();
                
                // Processamento de artistas e gêneros
                const artistsMap = new Map(); // artistId -> {nome, count, trackIds}
                
                // Primeiro, contamos a ocorrência de cada artista
                for (const item of tracks) {
                    const track = item.track;
                    
                    for (const artist of track.artists) {
                        if (!artistsMap.has(artist.id)) {
                            artistsMap.set(artist.id, {
                                id: artist.id,
                                name: artist.name,
                                count: 0,
                                trackIds: new Set(),
                                externalUrl: artist.external_urls.spotify
                            });
                        }
                        
                        const artistData = artistsMap.get(artist.id);
                        artistData.count += 1;
                        artistData.trackIds.add(track.id);
                    }
                }
                
                // Pegando artistas únicos e buscando seus gêneros
                const uniqueArtists = Array.from(artistsMap.values());
                
                for (const artist of uniqueArtists) {
                    // Para evitar muitas requisições, só buscaremos gêneros para artistas com 2+ músicas salvas
                    if (artist.count >= 2) {
                        try {
                            const genres = await fetchArtistGenres(artist.id);
                            
                            // Contabilizando pontuação de cada gênero
                            for (const genre of genres) {
                                if (!genreScores[genre]) {
                                    genreScores[genre] = 0;
                                    artistsByGenre[genre] = [];
                                }
                                
                                genreScores[genre] += artist.count;
                                artistsByGenre[genre].push(artist);
                            }
                        } catch (error) {
                            console.error('Erro ao buscar gêneros para:', artist.name, error);
                        }
                    }
                }
                
                // Ordenando artistas por gênero
                for (const genre in artistsByGenre) {
                    artistsByGenre[genre].sort((a, b) => b.count - a.count);
                }
                
                // Iniciar o sorteio de gêneros
                selectRandomGenres();
                
            } catch (error) {
                console.error('Erro ao processar músicas:', error);
                alert('Ocorreu um erro ao processar suas músicas. Por favor, tente novamente.');
                loginContainer.style.display = 'block';
                loadingElement.style.display = 'none';
            }
        }
        
        function selectRandomGenres() {
            // Filtrando apenas gêneros com pontuação (>0)
            const availableGenres = Object.keys(genreScores).filter(genre => genreScores[genre] > 0);
            
            if (availableGenres.length < 2) {
                alert('Não foi possível encontrar gêneros suficientes. Por favor, salve mais músicas variadas.');
                loginContainer.style.display = 'block';
                loadingElement.style.display = 'none';
                return;
            }
            
            // Sorteando 2 gêneros
            const randomIndices = [];
            while (randomIndices.length < 2) {
                const index = Math.floor(Math.random() * availableGenres.length);
                if (!randomIndices.includes(index)) {
                    randomIndices.push(index);
                }
            }
            
            selectedGenres = [
                {
                    name: availableGenres[randomIndices[0]],
                    score: genreScores[availableGenres[randomIndices[0]]]
                },
                {
                    name: availableGenres[randomIndices[1]],
                    score: genreScores[availableGenres[randomIndices[1]]]
                }
            ];
            
            // Embaralhando a ordem de exibição
            if (Math.random() > 0.5) {
                [selectedGenres[0], selectedGenres[1]] = [selectedGenres[1], selectedGenres[0]];
            }
            
            // Exibindo os gêneros para seleção
            displayGenreSelection();
        }
        
        function displayGenreSelection() {
            genreButtons.innerHTML = '';
            
            for (const genre of selectedGenres) {
                const button = document.createElement('button');
                button.classList.add('genre-button');
                button.textContent = formatGenreName(genre.name);
                button.addEventListener('click', () => handleGenreSelection(genre));
                genreButtons.appendChild(button);
            }
            
            loadingElement.style.display = 'none';
            genreSelection.style.display = 'block';
        }
        
        function formatGenreName(genre) {
            // Capitaliza a primeira letra de cada palavra do gênero
            return genre.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        function handleGenreSelection(selectedGenre) {
            // Obtendo o outro gênero (não selecionado)
            const otherGenre = selectedGenres.find(genre => genre.name !== selectedGenre.name);
            
            if (selectedGenres[0].score === selectedGenres[1].score || selectedGenre.score < otherGenre.score) {
                // Se os gêneros têm pontuação igual OU o usuário selecionou o de menor pontuação
                displayArtistsByGenre(selectedGenre.name);
            } else {
                // Se o usuário selecionou o de maior pontuação, fazer novo sorteio
                selectRandomGenres();
            }
        }
        
        function displayArtistsByGenre(genre) {
            genreSelection.style.display = 'none';
            artistList.style.display = 'block';
            backButton.style.display = 'block';
            
            selectedGenreTitle.textContent = `Artistas de ${formatGenreName(genre)}`;
            artistContainer.innerHTML = '';
            
            const artists = artistsByGenre[genre] || [];
            
            if (artists.length === 0) {
                artistContainer.innerHTML = '<p>Nenhum artista encontrado para este gênero.</p>';
                return;
            }
            
            for (const artist of artists) {
                const artistLink = document.createElement('a');
                artistLink.href = artist.externalUrl;
                artistLink.target = '_blank';
                artistLink.innerHTML = `${artist.name} <span class="artist-count">${artist.count} música${artist.count > 1 ? 's' : ''}</span>`;
                artistContainer.appendChild(artistLink);
            }
        }
        
        // Event Listeners
        loginButton.addEventListener('click', login);
        
        backButton.addEventListener('click', () => {
            artistList.style.display = 'none';
            backButton.style.display = 'none';
            selectRandomGenres();
        });
        
        // Inicialização
        window.onload = function() {
            const params = getHashParams();
            accessToken = params.access_token;
            
            if (accessToken) {
                // Remover o token do URL por segurança
                history.replaceState({}, document.title, redirectUri.split('#')[0]);
                processSavedTracks();
            }
        };
    </script>
</body>
</html>
